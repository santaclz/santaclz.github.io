---
layout: post
title: "Linux Kernel Exploitation"
---

# Motivation

I started my journey into the Linux kernel exploitation for the following reasons:
- To improve my knowledge of Linux kernel
- Write exploits for real world bugs
- To research IoT devices with modified Linux kernel
- Pwn Google’s kCTF platform
- To get invited to conferences :)

# Where are kernel exploits used?

Kernel exploits are used (to my knowledge) by the following groups of people:
- Thread actors: to escalate privileges
- Pentesters: to demonstrate impact
- Defenders: coming up with detections and mitigations
- Kernel / driver developers: to write patches
- Android / iOS superusers: to customize phones

# Linux kernel oversimplified

Linux kernel is a layer between user applications and hardware. It manages this like CPU, memory, devices, file system, networking, process control and many other things. It's a complex project with over 8 million lines of code and it's still evolving. Such a dynamic project is an ideal research target.

# Kernelspace vs Userspace exploitation (x86_64)

If you're coming from userspace exploitation (like me) you may notice the following differences when writing kernel exploits.

### More instructions

Instructions such as:

- LGDT - Loads an address of a GDT into GDTR
- LLDT - Loads an address of a LDT into LDTR
- LTR - Loads a Task Register into TR
- MOV Control Register - Copy data and store in Control Registers
- LMSW - Load a new Machine Status WORD
- CLTS - Clear Task Switch Flag in Control Register CR0
- MOV Debug Register - Copy data and store in debug registers
- INVD - Invalidate Cache without writeback
- INVLPG - Invalidate TLB Entry
- WBINVD - Invalidate Cache with writeback
- HLT - Halt Processor
- RDMSR - Read Model Specific Registers (MSR)
- WRMSR - Write Model Specific Registers (MSR)
- RDPMC - Read Performance Monitoring Counter
- RDTSC - Read time Stamp Counter

With exceptions such as RDTSC which can also be run from userspace if TSD flag in register CR4 is not set.

### More registers

When debugging the kernel with gdb we can see additional registers:

- fs_base - base address of fs
- gs_base - base address of gs
- k_gs_base - stores the value of gs_base register while switching from userspace to kernelspace or vice versa
- cr0 - control register
- cr2 - control register
- cr3 - control register
- cr4 - control register
- cr8 - control register
- efer - Extended Feature Enable Register
- mxcsr - control and status for SSE registersŋ

# Video
Below is a video of a talk I gave at BSidesLjubljana in June 2023.

<iframe width="560" height="315" src="https://ia802709.us.archive.org/35/items/BSidesLjubljana2023/t1_06_Guide_To_Linux_Kernel_Exploitation-Ivor_Canjuga.mp4" frameborder="0" allowfullscreen></iframe>

# References

https://blog.trailofbits.com/2019/07/19/understanding-docker-container-escapes/

https://sam4k.com/linternals-memory-allocators-0x02/

https://lkmidas.github.io/posts/20210205-linux-kernel-pwn-part-3/

https://seal9055.com/blog/kernel/return_oriented_programming

https://breaking-bits.gitbook.io/breaking-bits/exploit-development/linux-kernel-exploit-development/kernel-page-table-isolation-kpti#kpti-trampoline

https://ptr-yudai.hatenablog.com/entry/2020/03/16/165628

https://pwn.college/system-security/kernel-security

https://github.com/google/syzkaller/

https://research.nccgroup.com/2018/09/11/ncc-groups-exploit-development-capability-why-and-what/

https://lwn.net/Articles/824307/

https://meltdownattack.com/meltdown.pdf

http://www.brokenthorn.com/Resources/OSDev23.html
